name: CI

on:
  push:
    name: CI

    on:
      push:
        branches: [ master, main ]
      pull_request:
        branches: [ master, main ]
      schedule:
        - cron: "0 3 * * *"  # nightly load smoke

    jobs:
      build-test:
        runs-on: ubuntu-latest
        env:
          POIT_DATABASE_URL: sqlite:///./ci.db
          POI_TRACING: ""  # disabled
        steps:
          - name: Checkout
            uses: actions/checkout@v4

          - name: Cache pip
            uses: actions/cache@v4
            with:
              path: ~/.cache/pip
              key: pip-${{ runner.os }}-${{ hashFiles('requirements.txt') }}
              restore-keys: |
                pip-${{ runner.os }}-

          - name: Setup Python
            uses: actions/setup-python@v5
            with:
              python-version: '3.11'

          - name: Install backend deps
            run: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
              pip install cyclonedx-bom pip-licenses

          - name: Ruff Lint
            run: ruff check .

          - name: Mypy Type Check
            run: mypy app

          - name: Bandit Security Scan (non-blocking for now)
            run: bandit -q -r app || true

          - name: Dependency Vulnerability Scan (non-blocking)
            run: pip-audit -r requirements.txt -f json -o audit.json || true

          - name: Prompt Governance Lint
            run: python scripts/prompt_lint.py

          - name: Run Backend Tests (coverage â‰¥85%)
            run: pytest --cov=app --cov-report=xml --cov-report=term --cov-fail-under=85 --maxfail=1

          - name: Export OpenAPI
            run: python scripts/export_openapi.py

          - name: Generate SBOM
            run: cyclonedx-py -o sbom.json -r

          - name: License Scan
            run: pip-licenses --allow-only="MIT,BSD,Apache,ISC" || { echo "Disallowed license detected"; exit 1; }

          - name: Cache node
            uses: actions/cache@v4
            with:
                path: frontend/node_modules
                key: node-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}
                restore-keys: |
                  node-${{ runner.os }}-

          - name: Setup Node
            uses: actions/setup-node@v4
            with:
              node-version: '18'

          - name: Install frontend deps
            working-directory: frontend
            run: npm ci

          - name: Accessibility Tests
            working-directory: frontend
            run: npm run test:a11y

          - name: Visual Regression Tests
            working-directory: frontend
            run: npx playwright test

          - name: Build Docker image
            run: docker build -t poi-compass:ci .

          - name: Upload Artifacts
            if: always()
            uses: actions/upload-artifact@v4
            with:
              name: build-artifacts
              path: |
                coverage.xml
                sbom.json
                openapi.json
                frontend/playwright-report
                audit.json

      load-test-smoke:
        if: github.event_name == 'schedule'
        runs-on: ubuntu-latest
        steps:
          - name: Checkout
            uses: actions/checkout@v4
          - name: Setup Python
            uses: actions/setup-python@v5
            with:
              python-version: '3.11'
          - name: Install deps
            run: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
              pip install locust
          - name: Start API
            run: |
              python -m uvicorn app.main:app --port 8000 &
              sleep 3
          - name: Run Locust Smoke
            run: locust -f locustfile.py --headless -u 5 -r 2 -t 1m --host http://localhost:8000
        run: |
          locust -f locustfile.py --headless -u 5 -r 2 -t 1m --host http://localhost:8000
