name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    env:
      POIT_DATABASE_URL: sqlite:///./ci.db
      POI_TRACING: ""  # disabled
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
            python-version: '3.11'

      - name: Install backend deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint (ruff)
        run: ruff check .

      - name: Type check (mypy)
        run: mypy app

      - name: Security scan (bandit)
        run: bandit -q -r app || true

      - name: Dependency audit (pip-audit)
        run: pip-audit -f json -o audit.json || true

      - name: Run tests with coverage
        run: pytest --maxfail=1 --cov=app --cov-report=xml --cov-report=term --cov-fail-under=85

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: coverage.xml

      - name: Build Docker image
        run: docker build -t poi-compass:ci .
name: CI
on:
  push:
    branches: [ master, docs/poi-compass-foundation ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: "0 3 * * *"  # nightly UTC run for load test smoke

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ruff Lint
        run: |
          python -m ruff check .

      - name: Mypy Type Check
        run: |
          mypy app

      - name: Bandit Security Scan
        run: |
          bandit -q -r app || exit 1

      - name: Dependency Vulnerability Scan
        run: |
          pip-audit -r requirements.txt || exit 1
      - name: License Scan
        run: |
          pip-licenses --allow-only="MIT,BSD,Apache,ISC" || { echo "Disallowed license detected"; exit 1; }

      - name: Prompt Governance Lint
        run: |
          python scripts/prompt_lint.py

      - name: Run tests with coverage threshold
        run: |
          pytest --cov=app --cov-report=term --cov-fail-under=80 --maxfail=1 -q

      - name: Schema presence check
        run: |
          for f in schemas/*.schema.json; do [ -f "$f" ] || exit 1; done

      - name: Secret scan placeholder
        run: |
          grep -R "OPENAI_API_KEY" -n . && echo "No key values present" || true

      - name: Generate SBOM
        run: |
          cyclonedx-py -o sbom.json -r

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json
      - name: Export OpenAPI
        run: |
          python scripts/export_openapi.py
      - name: Upload OpenAPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: openapi
          path: openapi.json
      - name: Build Docker Image
        run: |
          docker build -t poi-compass:ci .
      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source . --no-git -v

  load-test-smoke:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies (locust)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install locust
      - name: Start API server
        run: |
          python -m uvicorn app.main:app --port 8000 &
          sleep 3
      - name: Run locust smoke test
        run: |
          locust -f locustfile.py --headless -u 5 -r 2 -t 1m --host http://localhost:8000
